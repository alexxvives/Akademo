// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      String   @default("STUDENT") // "ADMIN" | "TEACHER" | "STUDENT"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedAcademies     Academy[]            @relation("AcademyOwner")
  academyMemberships AcademyMembership[]
  classEnrollments   ClassEnrollment[]
  videoPlayStates    VideoPlayState[]
  deviceSessions     DeviceSession[]
  uploadsCreated     Upload[]             @relation("UploadCreator")
}

model Academy {
  id          String         @id @default(cuid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Settings for defaults (nullable = use platform defaults)
  defaultMaxWatchTimeMultiplier Float? @default(2.0)

  // Relations
  owner       User                @relation("AcademyOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  memberships AcademyMembership[]
  classes     Class[]
  billing     BillingConfig?
}

model AcademyMembership {
  id         String           @id @default(cuid())
  userId     String
  academyId  String
  status     String @default("PENDING") // "PENDING" | "APPROVED" | "REJECTED"
  requestedAt DateTime        @default(now())
  approvedAt DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  academy Academy @relation(fields: [academyId], references: [id], onDelete: Cascade)

  @@unique([userId, academyId])
}

model Class {
  id          String   @id @default(cuid())
  name        String
  description String?
  academyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Settings (nullable = inherit from academy)
  defaultMaxWatchTimeMultiplier Float? @default(2.0)

  // Relations
  academy     Academy           @relation(fields: [academyId], references: [id], onDelete: Cascade)
  enrollments ClassEnrollment[]
  documents   Document[]
  videos      Video[]
}

model ClassEnrollment {
  id        String   @id @default(cuid())
  classId   String
  studentId String
  enrolledAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
}

model Document {
  id          String   @id @default(cuid())
  title       String
  description String?
  classId     String
  uploadId    String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  class  Class  @relation(fields: [classId], references: [id], onDelete: Cascade)
  upload Upload @relation(fields: [uploadId], references: [id], onDelete: Cascade)
}

model Video {
  id          String   @id @default(cuid())
  title       String
  description String?
  classId     String
  uploadId    String   @unique
  durationSeconds Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Per-video settings - now tracking total watch time instead of play count
  maxWatchTimeMultiplier Float? @default(2.0) // e.g., 2.0 = can watch for 2x video duration

  // Relations
  class      Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  upload     Upload           @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  playStates VideoPlayState[]
}

model Upload {
  id           String   @id @default(cuid())
  fileName     String
  fileSize     Int
  mimeType     String
  storageType  String   // "local" or "r2"
  storagePath  String   // local path or R2 key
  uploadedById String
  createdAt    DateTime @default(now())

  // Relations
  uploadedBy User      @relation("UploadCreator", fields: [uploadedById], references: [id], onDelete: Cascade)
  document   Document?
  video      Video?
}

model VideoPlayState {
  id        String   @id @default(cuid())
  videoId   String
  studentId String
  
  // New watch time tracking system
  totalWatchTimeSeconds   Float    @default(0) // Total time actually watched (playing)
  lastPositionSeconds     Float    @default(0) // Current position in video
  sessionStartTime        DateTime? // When current play session started
  
  // Timestamps
  lastWatchedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  video   Video @relation(fields: [videoId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([videoId, studentId])
}

model DeviceSession {
  id             String   @id @default(cuid())
  userId         String
  deviceFingerprint String
  userAgent      String?
  ipHash         String?
  browser        String?
  os             String?
  isActive       Boolean  @default(true)
  lastActiveAt   DateTime @default(now())
  createdAt      DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceFingerprint])
}

model PlatformSettings {
  id    String @id @default("platform_settings")
  
  // Platform-wide defaults - now using watch time multiplier
  defaultMaxWatchTimeMultiplier Float @default(2.0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Future billing support
model BillingConfig {
  id        String   @id @default(cuid())
  academyId String   @unique
  
  // Stripe integration (future)
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  stripePriceId          String?
  
  // Settings
  pricePerStudentPerMonth Float @default(1.0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  academy Academy @relation(fields: [academyId], references: [id], onDelete: Cascade)
}
